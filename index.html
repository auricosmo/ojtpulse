<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OJT Pulse Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        matcha: { 100: '#E4F0D5', 200: '#C8E1AA', 300: '#ADD280', 400: '#92C355', 500: '#77B42B', 600: '#5F9022' },
                        sky: { 50: '#F0F9FF', 100: '#E0F2FE', 500: '#0EA5E9', 600: '#0284C7' },
                        rose: { 50: '#FFF1F2', 100: '#FFE4E6', 500: '#F43F5E', 600: '#E11D48' },
                        violet: { 50: '#F5F3FF', 100: '#EDE9FE', 500: '#8B5CF6', 600: '#7C3AED' },
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c', 800: '#292524', 900: '#1c1917' },
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        input[type='range'] { -webkit-appearance: none; background: transparent; }
        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
            background: var(--thumb-color, #77B42B); border-radius: 50%; border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); cursor: pointer; transition: background 0.1s ease; margin-top: -5px; 
        }
        input[type='range']::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #f5f5f4; border-radius: 9999px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pie-chart { width: 60px; height: 60px; border-radius: 50%; background: #f5f5f4; position: relative; }
        .pie-chart::after { content: ""; position: absolute; inset: 10px; background: rgba(255, 255, 255, 0.9); border-radius: 50%; backdrop-filter: blur(4px); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.75rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .calendar-day:hover:not(.active) { background-color: #f5f5f4; }
        .calendar-day.active { background-color: #77B42B; color: white; font-weight: bold; }
        .calendar-day.today { border: 1px solid #77B42B; color: #77B42B; }
        .cal-dot { width: 4px; height: 4px; border-radius: 50%; margin-top: 2px; }
        .auth-overlay { position: fixed; inset: 0; background-color: #FDFCF8; z-index: 60; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-[#FDFCF8] text-stone-800 font-sans min-h-screen relative pb-20">

    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-stone-50 transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-matcha-500"></div>
    </div>

    <div id="auth-screen" class="hidden auth-overlay">
        <div class="bg-white/80 backdrop-blur-xl p-10 rounded-[2.5rem] shadow-xl border border-white/60 text-center max-w-sm mx-4">
            <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-6 text-matcha-600 shadow-md border border-matcha-100">
                <i data-lucide="refresh-cw" class="w-10 h-10"></i>
            </div>
            <h2 class="text-2xl font-black text-stone-800 mb-2 tracking-tight">Sync your progress</h2>
            <p class="text-stone-500 text-sm mb-8">Sign in to securely track your attendance and OJT logs.</p>
            <button id="btn-login-google" class="w-full py-3.5 bg-white hover:bg-stone-50 text-stone-700 font-bold rounded-2xl transition-all shadow-md border border-stone-200 flex items-center justify-center gap-3 active:scale-95">
                <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.04-3.71 1.04-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                <span>Continue with Google</span>
            </button>
        </div>
    </div>

    <div id="app" class="relative z-10 opacity-0 transition-opacity duration-500">
        <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-white/60 mb-6">
            <div class="max-w-[1600px] mx-auto px-6 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-matcha-100 rounded-xl"><i data-lucide="brain" class="text-matcha-600 w-5 h-5"></i></div>
                    <div>
                        <h1 class="text-base font-black text-stone-800 leading-none">OJT Pulse</h1>
                        <p class="text-[10px] text-stone-400 font-bold uppercase tracking-widest mt-0.5" id="header-date">Today</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div id="user-profile" class="hidden items-center gap-2 px-2 py-1 bg-stone-50 rounded-full border border-stone-200">
                        <img id="user-avatar" src="" class="w-6 h-6 rounded-full bg-stone-200" />
                        <span id="user-name-display" class="text-xs font-bold text-stone-600 pr-1 truncate max-w-[100px]"></span>
                    </div>
                    <button id="btn-logout" class="p-2 hover:bg-rose-50 rounded-xl text-stone-400 hover:text-rose-500 transition-colors"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    <div id="big-clock" class="text-lg font-black text-stone-700 bg-white px-3 py-1 rounded-xl border border-stone-100">--:--</div>
                </div>
            </div>
        </header>

        <main class="max-w-[1600px] mx-auto px-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
            <aside class="lg:col-span-3 space-y-6">
                <div class="bg-white/70 backdrop-blur-md p-5 rounded-[1.5rem] border border-white/60 shadow-sm space-y-4">
                    <h3 class="font-bold text-stone-700 text-sm mb-2">Daily Vitals</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-att-present" class="p-2 rounded-xl border bg-white text-xs font-bold">Present</button>
                        <button id="btn-att-halfday" class="p-2 rounded-xl border bg-white text-xs font-bold">Half</button>
                        <button id="btn-att-absent" class="p-2 rounded-xl border bg-white text-xs font-bold">Absent</button>
                        <button id="btn-att-off" class="p-2 rounded-xl border bg-white text-xs font-bold">Off</button>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-rose-50 rounded-2xl">
                        <span class="text-xs font-bold text-rose-700">Avg Tension</span>
                        <span id="stat-tension" class="text-xl font-black">1.0</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-violet-50 rounded-2xl">
                        <span class="text-xs font-bold text-violet-700">Mood Mix</span>
                        <div id="mood-pie-chart" class="pie-chart w-10 h-10"></div>
                    </div>
                </div>
                <textarea id="scratchpad" class="w-full bg-amber-50 border-none rounded-[1.5rem] p-5 text-sm h-48 focus:ring-0" placeholder="Scratchpad..."></textarea>
            </aside>

            <section class="lg:col-span-6 space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-3xl font-black">Hi, <span id="welcome-name">Student</span></h2>
                    <button id="btn-food" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-white border border-stone-100 text-xs font-bold">
                        Yummy Food? <div id="toggle-food-bg" class="w-8 h-4 rounded-full bg-stone-200 relative"><div id="toggle-food-dot" class="absolute top-0.5 left-0.5 w-3 h-3 rounded-full bg-white transition-all"></div></div>
                    </button>
                </div>
                <div class="flex items-center gap-4 bg-white/50 p-2 rounded-2xl w-fit">
                    <button id="btn-prev-day"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <div class="relative font-bold text-matcha-600">
                        <span id="roadmap-title">Today</span>
                        <input type="date" id="date-picker-input" class="absolute inset-0 opacity-0 cursor-pointer">
                    </div>
                    <button id="btn-next-day"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
                <div id="timeline-container" class="space-y-4"></div>
            </section>

            <aside class="lg:col-span-3 space-y-6">
                <div class="bg-white p-5 rounded-[1.5rem] border shadow-sm">
                    <div class="flex justify-between mb-3"><h3 class="font-bold text-sm">OJT Progress</h3><button id="btn-settings"><i data-lucide="settings" class="w-4 h-4"></i></button></div>
                    <div class="text-3xl font-black mb-1" id="progress-percent">0%</div>
                    <div class="text-xs text-stone-500 mb-3" id="progress-hours">0 / 600 hrs</div>
                    <div class="w-full bg-stone-100 h-2 rounded-full overflow-hidden"><div id="progress-bar" class="bg-matcha-500 h-full w-0 transition-all duration-1000"></div></div>
                    <p class="text-[10px] text-stone-400 mt-2" id="progress-days">Day 0</p>
                </div>
                <div class="bg-white p-5 rounded-[1.5rem] border shadow-sm">
                    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-sm" id="cal-month-year">Month</h3><div class="flex gap-2"><button id="btn-cal-prev"><i data-lucide="chevron-left" class="w-4 h-4"></i></button><button id="btn-cal-next"><i data-lucide="chevron-right" class="w-4 h-4"></i></button></div></div>
                    <div class="calendar-grid text-center text-[10px] text-stone-400 font-bold mb-2"><span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span></div>
                    <div id="mini-calendar" class="calendar-grid"></div>
                </div>
                <div class="flex flex-col gap-2">
                    <button id="btn-export-local" class="w-full py-2 bg-stone-100 rounded-xl text-xs font-bold">Export JSON</button>
                    <button id="btn-import-local" class="w-full py-2 bg-stone-100 rounded-xl text-xs font-bold">Import JSON</button>
                    <input type="file" id="file-input" class="hidden" accept=".json">
                </div>
            </aside>
        </main>
    </div>

    <div id="modal-settings" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/40 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-[2rem] w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4">OJT Settings</h3>
            <div class="space-y-4">
                <label class="block text-xs font-bold text-stone-400 uppercase">Start Date</label>
                <input type="date" id="setting-start-date" class="w-full bg-stone-50 border rounded-xl px-4 py-3">
                <label class="block text-xs font-bold text-stone-400 uppercase">Total Hours Required</label>
                <input type="number" id="setting-total-hours" class="w-full bg-stone-50 border rounded-xl px-4 py-3">
                <div class="flex gap-3 pt-4">
                    <button id="btn-close-settings" class="flex-1 py-3 font-bold text-stone-400">Cancel</button>
                    <button id="btn-save-settings" class="flex-1 py-3 bg-matcha-500 text-white font-bold rounded-xl">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBJhEWSJ8Tz2DBwychFeQVlhXCYD1D8YLY",
            authDomain: "ojt-pulse-tracker-backen-160ad.firebaseapp.com",
            projectId: "ojt-pulse-tracker-backen-160ad",
            storageBucket: "ojt-pulse-tracker-backen-160ad.firebasestorage.app",
            messagingSenderId: "859757491435",
            appId: "1:859757491435:web:0737b9c1f9380628b03aae"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const HOURS = ["07:00 AM", "08:00 AM", "09:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "01:00 PM", "02:00 PM", "03:00 PM", "04:00 PM", "05:00 PM"];
        const moodColors = { 'happy': '#77B42B', 'neutral': '#a8a29e', 'stressed': '#F43F5E', 'tired': '#8B5CF6', 'productive': '#F59E0B' };
        const stressColors = { 1: '#77B42B', 2: '#a3e635', 3: '#facc15', 4: '#fb923c', 5: '#ef4444' };
        const WEATHER = [ { icon: 'sun', label: 'Sunny', color: 'text-amber-400' }, { icon: 'cloud', label: 'Cloudy', color: 'text-stone-400' }, { icon: 'cloud-rain', label: 'Rainy', color: 'text-sky-400' }, { icon: 'cloud-lightning', label: 'Stormy', color: 'text-violet-400' } ];
        const MOODS = [ { emoji: 'ðŸ˜Š', value: 'happy' }, { emoji: 'ðŸ˜', value: 'neutral' }, { emoji: 'ðŸ˜«', value: 'stressed' }, { emoji: 'ðŸ˜´', value: 'tired' }, { emoji: 'ðŸ”¥', value: 'productive' } ];

        let currentUser = null, selectedDate = new Date(), currentMonth = new Date(), dailyLog = {}, ojtSettings = { startDate: '', totalHours: 600 }, allLogsCache = {}, scratchTimeout;

        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('user-profile').classList.replace('hidden', 'flex');
                if(user.photoURL) document.getElementById('user-avatar').src = user.photoURL;
                document.getElementById('user-name-display').innerText = user.displayName || 'User';
                document.getElementById('welcome-name').innerText = user.displayName ? user.displayName.split(' ')[0] : 'Student';
                
                document.getElementById('app').classList.remove('opacity-0');
                document.getElementById('loading').classList.add('hidden');

                initSettings();
                loadLocalLogs();
                subscribeToDate();
            } else {
                currentUser = null;
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('loading').classList.add('hidden');
            }
            if(window.lucide) lucide.createIcons();
        });

        function getLocalISODate(date) {
            const offset = date.getTimezoneOffset() * 60000; 
            return new Date(date.getTime() - offset).toISOString().split('T')[0];
        }

        function loadLocalLogs() {
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('ojt_pulse_log_')) {
                    const dateKey = key.replace('ojt_pulse_log_', '');
                    try {
                        allLogsCache[dateKey] = JSON.parse(localStorage.getItem(key));
                    } catch(e) { console.error("Cache load error", e); }
                }
            });
            renderCalendar(); updateProgress();
        }

        async function initSettings() {
            const localSettings = localStorage.getItem('ojt_pulse_settings');
            if(localSettings) ojtSettings = JSON.parse(localSettings);
            const localScratch = localStorage.getItem('ojt_pulse_scratchpad');
            if(localScratch) document.getElementById('scratchpad').value = localScratch;
            updateProgress();
        }

        function subscribeToDate() {
            const key = getLocalISODate(selectedDate);
            document.getElementById('header-date').innerText = selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            document.getElementById('date-picker-input').value = key;
            document.getElementById('roadmap-title').innerText = selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            
            const localStored = localStorage.getItem('ojt_pulse_log_' + key);
            if(localStored) {
                dailyLog = JSON.parse(localStored);
            } else {
                dailyLog = { date: key, deliciousFood: false, attendance: 'absent', hours: HOURS.reduce((a,h)=>({...a,[h]:{task:'',stress:1,mood:'neutral',weather:'Sunny'}}), {}) };
            }
            renderUI(); renderCalendar(); updateProgress();
        }

        function renderUI() {
            const container = document.getElementById('timeline-container');
            const activeHours = dailyLog.hours || {};

            container.innerHTML = HOURS.map(h => {
                const data = activeHours[h] || {task:'', stress:1, mood:'neutral', weather:'Sunny'};
                const col = stressColors[data.stress] || stressColors[1];
                const weatherBtns = WEATHER.map(w => `<button onclick="updateWeather('${h}','${w.label}')" class="p-1 rounded ${data.weather===w.label ? 'bg-stone-200 '+w.color : 'text-stone-300'}"><i data-lucide="${w.icon}" class="w-3 h-3"></i></button>`).join('');
                const moodBtns = MOODS.map(m => `<button onclick="updateMood('${h}','${m.value}')" class="w-8 h-8 flex items-center justify-center rounded-lg ${data.mood===m.value ? 'bg-white shadow-sm scale-110' : 'grayscale opacity-40'}">${m.emoji}</button>`).join('');

                return `<div class="bg-white p-5 rounded-[1.5rem] border shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xl font-black text-stone-700">${h}</span>
                        <div class="flex gap-1 p-1 bg-stone-50 rounded-lg">${weatherBtns}</div>
                    </div>
                    <input type="text" value="${data.task||''}" onchange="updateTask('${h}', this.value)" placeholder="What did you do?" class="w-full bg-stone-50 border-none rounded-xl p-3 text-sm focus:ring-2 focus:ring-matcha-100">
                    <div class="flex flex-col lg:flex-row gap-4 pt-4">
                        <div class="flex-1 flex items-center gap-3">
                            <span class="text-[9px] font-bold text-stone-400 uppercase">Stress</span>
                            <input type="range" min="1" max="5" value="${data.stress||1}" onchange="updateStress('${h}', this.value)" style="--thumb-color: ${col}" class="flex-1 h-1.5 bg-stone-100 rounded-lg">
                        </div>
                        <div class="flex gap-1">${moodBtns}</div>
                    </div>
                </div>`;
            }).join('');
            
            ['present', 'halfday', 'absent', 'off'].forEach(id => {
                const btn = document.getElementById(`btn-att-${id}`);
                const active = dailyLog.attendance === id;
                btn.className = `p-2 rounded-xl border text-xs font-bold transition-all ${active ? 'bg-matcha-500 text-white border-matcha-500 shadow-md' : 'bg-white text-stone-400 border-stone-100'}`;
                btn.onclick = () => window.updateAttendance(id);
            });

            const btnFoodDot = document.getElementById('toggle-food-dot');
            if (btnFoodDot) {
                btnFoodDot.style.left = dailyLog.deliciousFood ? "18px" : "2px";
                document.getElementById('toggle-food-bg').className = dailyLog.deliciousFood ? "w-8 h-4 rounded-full bg-matcha-500 relative transition-all" : "w-8 h-4 rounded-full bg-stone-200 relative transition-all";
            }
            
            renderAnalytics();
            if(window.lucide) lucide.createIcons();
        }

        window.saveDaily = async () => { 
            const key = getLocalISODate(selectedDate);
            allLogsCache[key] = dailyLog; 
            localStorage.setItem('ojt_pulse_log_' + key, JSON.stringify(dailyLog));
            renderUI(); renderCalendar(); updateProgress();
            if (currentUser) {
                try { await setDoc(doc(db, 'ojt', currentUser.uid, 'logs', key), dailyLog); } catch(e) {}
            }
        };

        window.updateTask = (h, v) => { dailyLog.hours[h].task = v; saveDaily(); };
        window.updateStress = (h, v) => { dailyLog.hours[h].stress = parseInt(v); saveDaily(); };
        window.updateMood = (h, v) => { dailyLog.hours[h].mood = v; saveDaily(); };
        window.updateWeather = (h, v) => { dailyLog.hours[h].weather = v; saveDaily(); };
        window.updateAttendance = (s) => { dailyLog.attendance = s; saveDaily(); };
        window.toggleFood = () => { dailyLog.deliciousFood = !dailyLog.deliciousFood; saveDaily(); };

        document.getElementById('btn-food').onclick = window.toggleFood;
        document.getElementById('btn-login-google').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => location.reload());
        document.getElementById('btn-prev-day').onclick = () => { selectedDate.setDate(selectedDate.getDate() - 1); subscribeToDate(); };
        document.getElementById('btn-next-day').onclick = () => { selectedDate.setDate(selectedDate.getDate() + 1); subscribeToDate(); };
        document.getElementById('btn-settings').onclick = () => {
            document.getElementById('setting-start-date').value = ojtSettings.startDate || '';
            document.getElementById('setting-total-hours').value = ojtSettings.totalHours || 600;
            document.getElementById('modal-settings').classList.remove('hidden');
        };
        document.getElementById('btn-close-settings').onclick = () => document.getElementById('modal-settings').classList.add('hidden');
        document.getElementById('btn-save-settings').onclick = () => {
            ojtSettings = { startDate: document.getElementById('setting-start-date').value, totalHours: document.getElementById('setting-total-hours').value };
            localStorage.setItem('ojt_pulse_settings', JSON.stringify(ojtSettings));
            document.getElementById('modal-settings').classList.add('hidden'); 
            updateProgress();
        };

        function renderAnalytics() {
            const logs = Object.values(dailyLog.hours || {});
            const avgStress = (logs.reduce((acc, l) => acc + (l.stress || 1), 0) / (logs.length || 1)).toFixed(1);
            document.getElementById('stat-tension').innerText = avgStress;
            
            const counts = logs.reduce((a, l) => { const m = l.mood || 'neutral'; a[m] = (a[m] || 0) + 1; return a; }, {});
            const chart = document.getElementById('mood-pie-chart');
            let cp = 0, segs = [];
            Object.keys(counts).forEach(m => { const p = (counts[m]/logs.length)*100; segs.push(`${moodColors[m]} ${cp}% ${cp+p}%`); cp += p; });
            chart.style.background = logs.length ? `conic-gradient(${segs.join(', ')})` : '#f5f5f4';
        }

        function updateProgress() {
            let hrs = 0;
            const totalReq = parseInt(ojtSettings.totalHours) || 600;
            Object.values(allLogsCache).forEach(l => {
                if(l.attendance === 'present') hrs += 8;
                if(l.attendance === 'halfday') hrs += 4;
            });
            const p = Math.round((hrs / totalReq) * 100);
            document.getElementById('progress-percent').innerText = p + '%';
            document.getElementById('progress-hours').innerText = `${hrs} / ${totalReq} hrs`;
            document.getElementById('progress-bar').style.width = p + '%';
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear(), month = currentMonth.getMonth();
            document.getElementById('cal-month-year').innerText = currentMonth.toLocaleDateString('en-US', {month:'long', year:'numeric'});
            const first = new Date(year, month, 1).getDay(), days = new Date(year, month+1, 0).getDate();
            const cal = document.getElementById('mini-calendar');
            cal.innerHTML = '';
            for(let i=0; i<first; i++) cal.innerHTML += '<div></div>';
            for(let d=1; d<=days; d++) {
                const key = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasData = allLogsCache[key] && allLogsCache[key].attendance !== 'absent';
                const el = document.createElement('div');
                el.className = `calendar-day ${key === getLocalISODate(selectedDate) ? 'active' : ''}`;
                el.innerHTML = `<span>${d}</span>${hasData ? '<div class="cal-dot bg-matcha-500"></div>' : ''}`;
                el.onclick = () => { selectedDate = new Date(year, month, d); subscribeToDate(); };
                cal.appendChild(el);
            }
        }

        setInterval(() => {
            document.getElementById('big-clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);
        
        document.getElementById('btn-cal-prev').onclick = () => { currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); };
        document.getElementById('btn-cal-next').onclick = () => { currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); };
    </script>
</body>
</html>
