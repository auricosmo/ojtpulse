<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OJT Pulse Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        matcha: { 100: '#E4F0D5', 200: '#C8E1AA', 300: '#ADD280', 400: '#92C355', 500: '#77B42B', 600: '#5F9022' },
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c', 800: '#292524', 900: '#1c1917' },
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        input[type='range'] { -webkit-appearance: none; background: transparent; }
        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
            background: var(--thumb-color, #77B42B); border-radius: 50%; border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); cursor: pointer; transition: background 0.1s ease; margin-top: -5px; 
        }
        input[type='range']::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #f5f5f4; border-radius: 9999px; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .pie-chart { width: 60px; height: 60px; border-radius: 50%; background: #f5f5f4; position: relative; }
        .pie-chart::after { content: ""; position: absolute; inset: 15px; background: rgba(255, 255, 255, 0.9); border-radius: 50%; backdrop-filter: blur(4px); }

        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.75rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; position: relative; }
        .calendar-day:hover:not(.active) { background-color: #f5f5f4; }
        .calendar-day.active { background-color: #77B42B; color: white; font-weight: bold; }
        .calendar-day.today { border: 1px solid #77B42B; color: #77B42B; }
        
        .cal-dot { width: 4px; height: 4px; border-radius: 50%; margin-top: 2px; }

        /* Intro Toast Animation */
        #intro-toast { animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideIn { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-[#FDFCF8] text-stone-800 font-sans min-h-screen relative selection:bg-matcha-200 selection:text-matcha-600 pb-20">

    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] rounded-full bg-matcha-200/30 blur-[120px]"></div>
        <div class="absolute top-[40%] right-[-5%] w-[40%] h-[40%] rounded-full bg-sky-100/40 blur-[100px]"></div>
        <div class="absolute bottom-[-10%] left-[20%] w-[60%] h-[40%] rounded-full bg-rose-100/30 blur-[120px]"></div>
    </div>

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-stone-50 transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-matcha-500"></div>
    </div>

    <!-- Intro / Warning Floating Toast -->
    <div id="intro-toast" class="fixed bottom-6 right-6 max-w-sm w-[calc(100%-3rem)] bg-white/95 backdrop-blur-xl p-5 rounded-2xl shadow-2xl shadow-stone-900/10 border border-stone-200 z-50 transform transition-all duration-500 hidden">
        <div class="flex items-start gap-4">
            <div class="p-2.5 bg-amber-50 text-amber-500 rounded-xl shrink-0">
                <i data-lucide="alert-triangle" class="w-5 h-5"></i>
            </div>
            <div>
                <h4 class="font-bold text-stone-800 mb-1">Important: Local Data</h4>
                <p class="text-xs text-stone-500 leading-relaxed mb-3">
                    Your logs are saved in this browser's cache. 
                    <span class="font-bold text-amber-600">Clearing your browser history/cache will delete all your progress.</span>
                </p>
                <div class="flex gap-2">
                    <button id="btn-intro-gotit" class="text-xs font-bold text-stone-400 hover:text-stone-600 px-3 py-2 rounded-lg hover:bg-stone-50 transition-colors">Got it</button>
                    <button id="btn-intro-backup" class="text-xs font-bold text-sky-600 bg-sky-50 hover:bg-sky-100 px-3 py-2 rounded-lg transition-colors">Download Backup</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="relative z-10 opacity-0 transition-opacity duration-500">
        <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-white/60 shadow-sm shadow-stone-200/5 mb-6">
            <div class="max-w-[1600px] mx-auto px-6 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-gradient-to-br from-matcha-200 to-matcha-100 rounded-xl shadow-inner">
                        <i data-lucide="brain" class="text-matcha-600 w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-base font-black text-stone-800 leading-none">OJT Pulse</h1>
                        <p class="text-[10px] text-stone-400 font-bold uppercase tracking-widest mt-0.5" id="header-date">Today</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btn-export-local" class="p-2 hover:bg-stone-100 rounded-xl text-stone-400 hover:text-sky-500 transition-colors" title="Download Backup">
                         <i data-lucide="download" class="w-5 h-5"></i>
                    </button>
                    <button id="btn-import-local" class="p-2 hover:bg-stone-100 rounded-xl text-stone-400 hover:text-matcha-500 transition-colors" title="Restore Backup">
                         <i data-lucide="upload" class="w-5 h-5"></i>
                    </button>
                    <!-- Hidden File Input -->
                    <input type="file" id="file-input" class="hidden" accept=".json" />

                    <div id="big-clock" class="text-lg font-black text-stone-700 bg-white/50 px-3 py-1.5 rounded-xl border border-white/60 flex items-center gap-1.5">
                        <span>--:--</span><span class="text-xs text-stone-400">AM</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-[1600px] mx-auto px-6 grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- LEFT COLUMN: Vitals & Scratchpad (lg:col-span-3) -->
            <aside class="lg:col-span-3 space-y-6 lg:sticky lg:top-24 order-2 lg:order-1">
                <div class="bg-white/70 backdrop-blur-md p-5 rounded-[1.5rem] shadow-sm border border-white/60 space-y-4">
                    <h3 class="font-bold text-stone-700 text-sm mb-2 flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4 text-stone-400"></i> Daily Vitals</h3>
                    <div class="p-3 bg-stone-50 rounded-2xl border border-stone-100">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold text-stone-600">Attendance</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="btn-att-present" class="p-2 rounded-xl border border-transparent bg-white text-stone-400 hover:text-matcha-600"><span class="text-[9px] font-bold block">Present</span></button>
                            <button id="btn-att-halfday" class="p-2 rounded-xl border border-transparent bg-white text-stone-400 hover:text-amber-600"><span class="text-[9px] font-bold block">Half</span></button>
                            <button id="btn-att-absent" class="p-2 rounded-xl border border-transparent bg-white text-stone-400 hover:text-rose-600"><span class="text-[9px] font-bold block">Absent</span></button>
                            <button id="btn-att-off" class="p-2 rounded-xl border border-transparent bg-white text-stone-400 hover:text-stone-600"><span class="text-[9px] font-bold block">Off</span></button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-rose-50 rounded-2xl">
                        <span class="text-xs font-bold text-rose-700">Tension</span>
                        <span id="stat-tension" class="text-xl font-black">1.0</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-violet-50 rounded-2xl">
                        <span class="text-xs font-bold text-violet-700">Top Vibe</span>
                        <div id="mood-pie-chart" class="pie-chart w-10 h-10"></div>
                    </div>
                </div>
                <div class="bg-amber-50/80 p-5 rounded-[1.5rem] shadow-sm border border-amber-100">
                    <h3 class="font-bold text-amber-800 text-sm mb-2 flex items-center gap-2"><i data-lucide="sticky-note" class="w-4 h-4 text-amber-500"></i> Scratchpad</h3>
                    <textarea id="scratchpad" class="w-full bg-transparent border-none rounded-xl p-3 text-sm focus:ring-0 resize-none h-48 no-scrollbar" placeholder="Notes..."></textarea>
                </div>
            </aside>

            <!-- CENTER COLUMN: Timeline -->
            <section class="lg:col-span-6 space-y-6 order-1 lg:order-2">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <h2 class="text-3xl font-black text-stone-800 flex items-center gap-2">
                            Hi, 
                            <input type="text" id="user-display-name" value="Student" class="bg-transparent border-b-2 border-dashed border-matcha-300 focus:border-matcha-500 outline-none text-stone-800 min-w-[80px] w-auto transition-colors p-0 m-0"/>
                        </h2>
                        <div class="flex items-center gap-2 mt-1">
                            <button id="btn-prev-day" class="hover:text-matcha-600"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <div class="relative group">
                                <span id="roadmap-title" class="text-stone-500 font-medium text-sm hover:text-matcha-600 cursor-pointer">Today</span>
                                <input type="date" id="date-picker-input" class="absolute inset-0 opacity-0 cursor-pointer" />
                            </div>
                            <button id="btn-next-day" class="hover:text-matcha-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <button id="btn-food" class="flex items-center gap-3 px-4 py-2 rounded-2xl bg-white border border-stone-100 shadow-sm">
                        <span class="font-bold text-xs">Yummy Food?</span>
                        <div id="toggle-food-bg" class="w-8 h-4 rounded-full bg-stone-200 relative"><div id="toggle-food-dot" class="absolute top-0.5 left-0.5 w-3 h-3 rounded-full bg-white transition-all"></div></div>
                    </button>
                </div>
                <!-- TIMELINE -->
                <div id="timeline-container" class="space-y-4 pb-20 min-h-[200px]"></div>
            </section>

            <!-- RIGHT COLUMN: Progress & Calendar -->
            <aside class="lg:col-span-3 space-y-6 order-3 lg:order-3">
                <div class="bg-white/70 p-5 rounded-[1.5rem] border border-white/60 shadow-sm">
                    <div class="flex justify-between mb-3">
                        <h3 class="font-bold text-sm">Progress</h3>
                        <button id="btn-settings"><i data-lucide="settings-2" class="w-4 h-4 text-stone-300 hover:text-stone-500"></i></button>
                    </div>
                    <div class="text-3xl font-black mb-2" id="progress-percent">0%</div>
                    <div class="text-xs text-stone-500 mb-2" id="progress-hours">0 / 0 hrs</div>
                    <div class="w-full bg-stone-100 h-2 rounded-full overflow-hidden">
                        <div id="progress-bar" class="bg-matcha-500 h-full w-0 transition-all duration-1000"></div>
                    </div>
                    <p class="text-[10px] text-stone-400 mt-2" id="progress-days">Day 0</p>
                </div>
                <div class="bg-white/70 p-5 rounded-[1.5rem] border border-white/60 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-stone-700 text-sm" id="cal-month-year">...</h3>
                        <div class="flex gap-1">
                            <button id="btn-cal-prev"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <button id="btn-cal-next"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="calendar-grid text-center text-[10px] text-stone-400 font-bold mb-2">
                        <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
                    </div>
                    <div id="mini-calendar" class="calendar-grid"></div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="modal-settings" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/20 backdrop-blur-md transition-opacity duration-300">
        <div class="bg-white p-8 rounded-[2rem] w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-6">Settings</h3>
            <div class="space-y-4">
                <input type="date" id="setting-start-date" class="w-full border rounded-xl p-3">
                <input type="number" id="setting-total-hours" placeholder="Total Hours Required" class="w-full border rounded-xl p-3">
                <button id="btn-save-settings" class="w-full py-3 bg-matcha-500 text-white font-bold rounded-xl">Save</button>
                <button id="btn-close-settings" class="w-full py-3 text-stone-400">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const HOURS = ["07:00 AM", "08:00 AM", "09:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "01:00 PM", "02:00 PM", "03:00 PM", "04:00 PM", "05:00 PM"];
            const moodColors = { 'happy': '#77B42B', 'neutral': '#a8a29e', 'stressed': '#F43F5E', 'tired': '#8B5CF6', 'productive': '#F59E0B' };
            const stressColors = { 1: '#77B42B', 2: '#a3e635', 3: '#facc15', 4: '#fb923c', 5: '#ef4444' };
            const WEATHER = [ { icon: 'sun', label: 'Sunny', color: 'text-amber-400' }, { icon: 'cloud', label: 'Cloudy', color: 'text-stone-400' }, { icon: 'cloud-rain', label: 'Rainy', color: 'text-sky-400' }, { icon: 'cloud-lightning', label: 'Stormy', color: 'text-violet-400' } ];
            const MOODS = [ { emoji: 'ðŸ˜Š', value: 'happy' }, { emoji: 'ðŸ˜', value: 'neutral' }, { emoji: 'ðŸ˜«', value: 'stressed' }, { emoji: 'ðŸ˜´', value: 'tired' }, { emoji: 'ðŸ”¥', value: 'productive' } ];

            let selectedDate = new Date(), currentMonth = new Date(), dailyLog = {}, scratchTimeout;
            let ojtSettings = JSON.parse(localStorage.getItem('ojt_pulse_settings')) || { startDate: '', totalHours: 600 };
            let userName = localStorage.getItem('ojt_pulse_username') || 'Student';

            // Init UI
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('opacity-0');
            document.getElementById('user-display-name').value = userName;
            document.getElementById('scratchpad').value = localStorage.getItem('ojt_pulse_scratchpad') || '';
            
            if (!localStorage.getItem('ojt_pulse_seen_intro')) {
                document.getElementById('intro-toast').classList.remove('hidden');
            }

            function loadData() {
                const key = selectedDate.toISOString().split('T')[0];
                const stored = localStorage.getItem('ojt_pulse_' + key);
                
                dailyLog = stored ? JSON.parse(stored) : { 
                    date: key, deliciousFood: false, attendance: 'absent', 
                    hours: HOURS.reduce((a,h)=>({...a,[h]:{task:'',stress:1,mood:'neutral',weather:'Sunny'}}), {}) 
                };
                
                // Ensure structure integrity even if loaded from old format
                HOURS.forEach(h => { if(!dailyLog.hours[h]) dailyLog.hours[h] = {task:'',stress:1,mood:'neutral',weather:'Sunny'}; });
                
                document.getElementById('header-date').innerText = selectedDate.toLocaleDateString('en-US', {month:'short', day:'numeric'});
                document.getElementById('roadmap-title').innerText = selectedDate.toLocaleDateString('en-US', {month:'short', day:'numeric'});
                document.getElementById('date-picker-input').value = key;

                renderUI(); renderCalendar(); updateProgress();
            }

            function saveDaily() {
                const key = selectedDate.toISOString().split('T')[0];
                localStorage.setItem('ojt_pulse_' + key, JSON.stringify(dailyLog));
                renderUI(); renderCalendar(); updateProgress();
            }

            function renderUI() {
                const container = document.getElementById('timeline-container');
                container.innerHTML = HOURS.map(h => {
                    const data = dailyLog.hours[h];
                    const col = stressColors[data.stress];
                    const weatherBtns = WEATHER.map(w => `<button onclick="updateWeather('${h}','${w.label}')" class="p-1 rounded ${data.weather===w.label ? 'bg-white shadow-sm '+w.color : 'text-stone-300'}"><i data-lucide="${w.icon}" class="w-3 h-3"></i></button>`).join('');
                    const moodBtns = MOODS.map(m => `<button onclick="updateMood('${h}','${m.value}')" class="w-8 h-8 flex items-center justify-center rounded-lg transition-all ${data.mood===m.value ? 'bg-white shadow-md scale-110' : 'text-stone-300 grayscale hover:grayscale-0'}">${m.emoji}</button>`).join('');

                    return `<div class="bg-white/70 backdrop-blur-md p-5 rounded-[1.5rem] border border-white/60 shadow-sm transition-all hover:bg-white/90">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xl font-black text-stone-700">${h}</span>
                            <div class="flex gap-1 p-1 bg-stone-50 rounded-lg">${weatherBtns}</div>
                        </div>
                        <input type="text" value="${data.task}" onchange="updateTask('${h}', this.value)" class="w-full bg-stone-50 border-none rounded-xl p-3 text-sm focus:ring-2 focus:ring-matcha-200" placeholder="Activity...">
                        <div class="flex flex-col lg:flex-row gap-4 pt-3">
                            <div class="flex-1 flex items-center gap-3">
                                <span class="text-[9px] font-bold text-stone-400 uppercase">Stress</span>
                                <input type="range" min="1" max="5" value="${data.stress}" onchange="updateStress('${h}', this.value)" oninput="this.style.setProperty('--thumb-color', '${stressColors[this.value]}')" style="--thumb-color: ${col}" class="flex-1 h-1.5 bg-stone-100 rounded-lg">
                            </div>
                            <div class="flex gap-1">${moodBtns}</div>
                        </div>
                    </div>`;
                }).join('');

                ['present', 'halfday', 'absent', 'off'].forEach(id => {
                    const btn = document.getElementById(`btn-att-${id}`);
                    const active = dailyLog.attendance === id;
                    let cls = "p-2 rounded-xl border border-transparent flex flex-col items-center justify-center transition-all ";
                    if(active) {
                        if(id==='present') cls += "bg-matcha-100 text-matcha-600 border-matcha-200 shadow-sm";
                        else if(id==='halfday') cls += "bg-amber-100 text-amber-600 border-amber-200 shadow-sm";
                        else if(id==='absent') cls += "bg-rose-100 text-rose-600 border-rose-200 shadow-sm";
                        else cls += "bg-stone-200 text-stone-600 border-stone-300 shadow-sm";
                    } else cls += "bg-white text-stone-400 hover:bg-stone-50";
                    btn.className = cls;
                    // FIX: Attach click listener here
                    btn.onclick = () => window.updateAttendance(id);
                });

                const btnFood = document.getElementById('toggle-food-bg');
                btnFood.className = dailyLog.deliciousFood ? "w-8 h-4 rounded-full bg-matcha-500 relative" : "w-8 h-4 rounded-full bg-stone-200 relative";
                document.getElementById('toggle-food-dot').style.left = dailyLog.deliciousFood ? "18px" : "2px";

                renderAnalytics();
                lucide.createIcons();
            }

            // Expose logic to window
            window.updateTask = (h, v) => { dailyLog.hours[h].task = v; saveDaily(); };
            window.updateStress = (h, v) => { dailyLog.hours[h].stress = parseInt(v); saveDaily(); };
            window.updateMood = (h, v) => { dailyLog.hours[h].mood = v; saveDaily(); };
            window.updateWeather = (h, v) => { dailyLog.hours[h].weather = v; saveDaily(); };
            window.updateAttendance = (s) => { dailyLog.attendance = s; saveDaily(); };
            window.toggleFood = () => { dailyLog.deliciousFood = !dailyLog.deliciousFood; saveDaily(); };
            window.saveSettings = () => {
                ojtSettings = { startDate: document.getElementById('setting-start-date').value, totalHours: document.getElementById('setting-total-hours').value };
                localStorage.setItem('ojt_pulse_settings', JSON.stringify(ojtSettings));
                document.getElementById('modal-settings').classList.add('hidden'); updateProgress();
            };

            function renderAnalytics() {
                if (!dailyLog.hours) return;
                const logs = Object.values(dailyLog.hours);
                const totalStress = logs.reduce((acc, l) => acc + (l.stress || 1), 0);
                const avgStress = (logs.length > 0 ? totalStress / logs.length : 1).toFixed(1);
                document.getElementById('stat-tension').innerText = isNaN(avgStress) ? '1.0' : avgStress;
                
                const counts = logs.reduce((a, l) => { a[l.mood]=(a[l.mood]||0)+1; return a; }, {});
                const chart = document.getElementById('mood-pie-chart');
                if(logs.length===0) { chart.style.background = '#f5f5f4'; return; }
                let cp = 0, segs = [];
                Object.keys(counts).forEach(m => {
                    const p = (counts[m]/logs.length)*100;
                    segs.push(`${moodColors[m]||'#e7e5e4'} ${cp}% ${cp+p}%`); cp += p;
                });
                chart.style.background = `conic-gradient(${segs.join(', ')})`;
            }

            function updateProgress() {
                let hrs = 0;
                Object.keys(localStorage).forEach(k => {
                    if(k.startsWith('ojt_pulse_')) {
                        const d = JSON.parse(localStorage.getItem(k));
                        if(d.attendance === 'present') hrs += 8;
                        if(d.attendance === 'halfday') hrs += 4;
                    }
                });
                const p = Math.min(100, Math.round((hrs / ojtSettings.totalHours) * 100)) || 0;
                document.getElementById('progress-percent').innerText = p + '%';
                document.getElementById('progress-hours').innerText = `${hrs} / ${ojtSettings.totalHours} hrs`;
                document.getElementById('progress-bar').style.width = p + '%';
                
                if(ojtSettings.startDate) {
                    const start = new Date(ojtSettings.startDate), now = new Date();
                    const diff = Math.ceil((now - start) / (1000 * 60 * 60 * 24));
                    document.getElementById('progress-days').innerText = `Day ${diff}`;
                }
            }

            function renderCalendar() {
                const year = currentMonth.getFullYear(), month = currentMonth.getMonth();
                document.getElementById('cal-month-year').innerText = currentMonth.toLocaleDateString('en-US', {month:'long', year:'numeric'});
                const first = new Date(year, month, 1).getDay(), days = new Date(year, month+1, 0).getDate();
                const cal = document.getElementById('mini-calendar');
                cal.innerHTML = '';
                for(let i=0; i<first; i++) cal.innerHTML += '<div></div>';
                for(let d=1; d<=days; d++) {
                    const key = new Date(year, month, d).toISOString().split('T')[0];
                    const active = key === selectedDate.toISOString().split('T')[0];
                    const stored = localStorage.getItem('ojt_pulse_'+key);
                    const data = stored ? JSON.parse(stored) : null;
                    const el = document.createElement('div');
                    el.className = `calendar-day ${active ? 'active' : ''}`;
                    el.innerHTML = `<span>${d}</span>`;
                    if(data && data.attendance && data.attendance !== 'absent') {
                        const dot = document.createElement('div');
                        dot.className = 'cal-dot ' + (data.attendance === 'present' ? 'bg-matcha-500' : (data.attendance === 'halfday' ? 'bg-amber-500' : 'bg-stone-400'));
                        el.appendChild(dot);
                    }
                    el.onclick = () => { selectedDate = new Date(year, month, d); loadData(); };
                    cal.appendChild(el);
                }
            }

            // Event Listeners
            document.getElementById('btn-prev-day').onclick = () => { selectedDate.setDate(selectedDate.getDate()-1); loadData(); };
            document.getElementById('btn-next-day').onclick = () => { selectedDate.setDate(selectedDate.getDate()+1); loadData(); };
            document.getElementById('btn-cal-prev').onclick = () => { currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); };
            document.getElementById('btn-cal-next').onclick = () => { currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); };
            document.getElementById('date-picker-input').onchange = (e) => { if(e.target.value) { selectedDate = new Date(e.target.value); loadData(); }};
            
            document.getElementById('btn-settings').onclick = () => {
                document.getElementById('setting-start-date').value = ojtSettings.startDate;
                document.getElementById('setting-total-hours').value = ojtSettings.totalHours;
                document.getElementById('modal-settings').classList.remove('hidden');
            };
            document.getElementById('btn-close-settings').onclick = () => document.getElementById('modal-settings').classList.add('hidden');
            document.getElementById('user-display-name').oninput = (e) => {
                userName = e.target.value; localStorage.setItem('ojt_pulse_username', userName);
            };
            document.getElementById('scratchpad').oninput = (e) => {
                clearTimeout(scratchTimeout);
                scratchTimeout = setTimeout(() => localStorage.setItem('ojt_pulse_scratchpad', e.target.value), 1000);
            };
            
            // Backup Buttons
            document.getElementById('btn-export-local').onclick = () => {
                const allData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('ojt_pulse_')) allData[key] = JSON.parse(localStorage.getItem(key));
                }
                const a = document.createElement('a');
                a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData));
                a.download = `OJT_Backup.json`;
                a.click();
            };
            
            document.getElementById('btn-import-local').onclick = () => document.getElementById('file-input').click();
            
            document.getElementById('file-input').onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        Object.keys(data).forEach(key => localStorage.setItem(key, JSON.stringify(data[key])));
                        alert('Data restored successfully!');
                        location.reload();
                    } catch (err) {
                        alert('Error reading backup file.');
                    }
                };
                reader.readAsText(file);
            };

            document.getElementById('btn-intro-gotit').onclick = () => {
                document.getElementById('intro-toast').classList.add('hidden');
                localStorage.setItem('ojt_pulse_seen_intro', 'true');
            };
            document.getElementById('btn-intro-backup').onclick = () => {
                document.getElementById('btn-export-local').click();
                document.getElementById('intro-toast').classList.add('hidden');
                localStorage.setItem('ojt_pulse_seen_intro', 'true');
            };

            setInterval(() => {
                const n = new Date(); document.getElementById('big-clock').innerHTML = `<span>${n.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}).split(' ')[0]}</span><span class="text-xs text-stone-400">${n.toLocaleTimeString([], {hour12:true}).split(' ')[1]}</span>`;
            }, 1000);

            loadData();
        });
    </script>
</body>
</html>
