<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OJT Pulse Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        matcha: { 100: '#E4F0D5', 200: '#C8E1AA', 300: '#ADD280', 400: '#92C355', 500: '#77B42B', 600: '#5F9022' },
                        sky: { 50: '#F0F9FF', 100: '#E0F2FE', 500: '#0EA5E9', 600: '#0284C7' },
                        rose: { 50: '#FFF1F2', 100: '#FFE4E6', 500: '#F43F5E', 600: '#E11D48' },
                        violet: { 50: '#F5F3FF', 100: '#EDE9FE', 500: '#8B5CF6', 600: '#7C3AED' },
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1', 400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c', 800: '#292524', 900: '#1c1917' },
                    }
                }
            }
        }
    </script>

    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        /* Custom Range Slider (Webkit) */
        input[type='range'] { -webkit-appearance: none; background: transparent; }
        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px; 
            height: 18px;
            background: var(--thumb-color, #77B42B); 
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background 0.1s ease;
            margin-top: -5px; 
        }
        input[type='range']::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px; 
            cursor: pointer;
            background: #f5f5f4;
            border-radius: 9999px;
        }

        /* Custom Range Slider (Firefox) */
        input[type='range']::-moz-range-thumb {
            width: 18px; 
            height: 18px;
            background: var(--thumb-color, #77B42B); 
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background 0.1s ease;
        }
        input[type='range']::-moz-range-track {
            width: 100%;
            height: 6px; 
            cursor: pointer;
            background: #f5f5f4;
            border-radius: 9999px;
        }
        
        /* Hide scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in-init { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .pie-chart {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f5f5f4;
            position: relative;
        }
        .pie-chart::after {
            content: "";
            position: absolute;
            inset: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            backdrop-filter: blur(4px);
        }

        #intro-toast { animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideIn { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { 
            aspect-ratio: 1; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.75rem; 
            border-radius: 0.5rem; 
            cursor: pointer;
            transition: all 0.2s;
        }
        .calendar-day:hover:not(.active) { background-color: #f5f5f4; }
        .calendar-day.active { background-color: #77B42B; color: white; font-weight: bold; }
        .calendar-day.today { border: 1px solid #77B42B; color: #77B42B; }
        .calendar-day.empty { pointer-events: none; }
    </style>
</head>
<body class="bg-[#FDFCF8] text-stone-800 font-sans min-h-screen relative selection:bg-matcha-200 selection:text-matcha-600 pb-20">

    <!-- Fixed Ambient Background -->
    <div class="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] rounded-full bg-matcha-200/30 blur-[120px]"></div>
        <div class="absolute top-[40%] right-[-5%] w-[40%] h-[40%] rounded-full bg-sky-100/40 blur-[100px]"></div>
        <div class="absolute bottom-[-10%] left-[20%] w-[60%] h-[40%] rounded-full bg-rose-100/30 blur-[120px]"></div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-stone-50 transition-opacity duration-500">
        <div class="flex flex-col items-center gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-matcha-500"></div>
            <p id="loading-text" class="text-stone-400 text-sm font-medium animate-pulse">Loading...</p>
        </div>
    </div>

    <!-- App Container -->
    <div id="app" class="relative z-10 opacity-0 transition-opacity duration-500">
        
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-white/60 shadow-sm shadow-stone-200/5 mb-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-gradient-to-br from-matcha-200 to-matcha-100 rounded-xl shadow-inner">
                        <i data-lucide="brain" class="text-matcha-600 w-5 h-5"></i>
                    </div>
                    <div>
                        <h1 class="text-base font-black text-stone-800 leading-none tracking-tight">OJT Pulse</h1>
                        <p class="text-[10px] text-stone-400 font-bold uppercase tracking-widest mt-0.5" id="header-date">Today</p>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button id="btn-data-modal" class="p-2 hover:bg-stone-100 rounded-xl text-stone-400 hover:text-sky-500 transition-colors" title="Backup & Data">
                        <i data-lucide="download" class="w-5 h-5"></i>
                    </button>
                    <!-- Clock -->
                    <div id="big-clock" class="text-lg font-black text-stone-700 tracking-tight bg-white/50 px-3 py-1.5 rounded-xl border border-white/60 shadow-sm flex items-center gap-1.5 hidden sm:flex">
                        <span>--:--</span>
                        <span class="text-xs text-stone-400 font-medium">AM</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Layout: Grid -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 relative z-10 fade-in-init grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- Sidebar (Right Side on Desktop, Top on Mobile) -->
            <aside class="lg:col-span-4 space-y-6 lg:order-2 lg:sticky lg:top-24 lg:self-start lg:max-h-[calc(100vh-7rem)] lg:overflow-y-auto no-scrollbar">
                
                <!-- 1. OJT Progress Widget -->
                <div class="bg-white/70 backdrop-blur-md p-5 rounded-[1.5rem] shadow-sm border border-white/60 relative group">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <div class="p-1.5 bg-matcha-100 rounded-lg text-matcha-600">
                                <i data-lucide="briefcase" class="w-4 h-4"></i>
                            </div>
                            <h3 class="font-bold text-stone-700 text-sm">OJT Progress</h3>
                        </div>
                        <button id="btn-settings" class="text-stone-300 hover:text-stone-500 transition-colors">
                            <i data-lucide="settings-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="mb-2 flex justify-between items-end">
                        <span class="text-3xl font-black text-stone-800" id="progress-percent">0%</span>
                        <span class="text-xs text-stone-500 font-medium mb-1" id="progress-hours">0 / 0 hrs</span>
                    </div>
                    <div class="w-full bg-stone-100 rounded-full h-2.5 overflow-hidden">
                        <div id="progress-bar" class="bg-matcha-500 h-full rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                    <p class="text-[10px] text-stone-400 mt-2 font-medium" id="progress-days">Day 0 of Internship</p>
                </div>

                <!-- 2. Mini Calendar Widget -->
                <div class="bg-white/70 backdrop-blur-md p-5 rounded-[1.5rem] shadow-sm border border-white/60">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-stone-700 text-sm" id="cal-month-year">...</h3>
                        <div class="flex gap-1">
                            <button id="btn-cal-prev" class="p-1 hover:bg-stone-100 rounded text-stone-400"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <button id="btn-cal-next" class="p-1 hover:bg-stone-100 rounded text-stone-400"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center text-[10px] text-stone-400 font-bold mb-2">
                        <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
                    </div>
                    <div id="mini-calendar" class="calendar-grid">
                        <!-- JS Generated -->
                    </div>
                </div>

                <!-- 3. Analytics Summary (Moved from Top) -->
                <div class="bg-white/70 backdrop-blur-md p-5 rounded-[1.5rem] shadow-sm border border-white/60 space-y-4">
                    <h3 class="font-bold text-stone-700 text-sm mb-2 flex items-center gap-2">
                        <i data-lucide="bar-chart-3" class="w-4 h-4 text-stone-400"></i> Daily Vitals
                    </h3>
                    
                    <!-- Productivity -->
                    <div class="flex items-center justify-between p-3 bg-sky-50/50 rounded-2xl border border-sky-100/50">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-white rounded-xl text-sky-500 shadow-sm"><i data-lucide="zap" class="w-4 h-4"></i></div>
                            <span class="text-xs font-bold text-sky-700">Productivity</span>
                        </div>
                        <span id="stat-productivity" class="text-xl font-black text-stone-800">0%</span>
                    </div>

                    <!-- Tension -->
                    <div class="flex items-center justify-between p-3 bg-rose-50/50 rounded-2xl border border-rose-100/50">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-white rounded-xl text-rose-500 shadow-sm"><i data-lucide="heart" class="w-4 h-4"></i></div>
                            <span class="text-xs font-bold text-rose-700">Tension</span>
                        </div>
                        <div class="text-right">
                            <span id="stat-tension" class="text-xl font-black text-stone-800">1.0</span>
                            <div class="flex gap-0.5 justify-end" id="tension-dots"></div>
                        </div>
                    </div>

                    <!-- Mood Pie -->
                    <div class="flex items-center justify-between p-3 bg-violet-50/50 rounded-2xl border border-violet-100/50">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-white rounded-xl text-violet-500 shadow-sm"><i data-lucide="smile" class="w-4 h-4"></i></div>
                            <span class="text-xs font-bold text-violet-700">Top Vibe</span>
                        </div>
                        <div id="mood-pie-chart" class="pie-chart w-10 h-10 shadow-sm"></div>
                    </div>
                </div>

                <!-- 4. Scratchpad -->
                <div class="bg-amber-50/80 backdrop-blur-md p-5 rounded-[1.5rem] shadow-sm border border-amber-100/50">
                    <h3 class="font-bold text-amber-800 text-sm mb-2 flex items-center gap-2">
                        <i data-lucide="sticky-note" class="w-4 h-4 text-amber-500"></i> Quick Scratchpad
                    </h3>
                    <textarea id="scratchpad" class="w-full bg-white/50 border-none rounded-xl p-3 text-sm text-stone-600 placeholder-amber-800/30 focus:ring-2 focus:ring-amber-200 focus:bg-white transition-all resize-none h-32 no-scrollbar leading-relaxed" placeholder="Jot down quick notes, reminders, or coffee orders here..."></textarea>
                </div>

            </aside>

            <!-- Main Timeline (Left on Desktop) -->
            <section class="lg:col-span-8 lg:order-1 space-y-6">
                
                <!-- Welcome & Date Header -->
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-2">
                    <div>
                        <h2 class="text-3xl font-black text-stone-800 tracking-tight flex items-center gap-2">
                            Hi, <input type="text" id="user-display-name" value="Student" class="bg-transparent border-b-2 border-dashed border-matcha-300 focus:border-matcha-500 outline-none text-stone-800 min-w-[80px] w-auto transition-colors p-0 m-0"/>
                        </h2>
                        <p class="text-stone-500 font-medium text-sm" id="roadmap-title">Let's log today.</p>
                    </div>
                    
                    <button id="btn-food" class="flex items-center gap-3 pl-4 pr-1.5 py-1.5 rounded-[1.2rem] transition-all duration-300 shadow-sm bg-white text-stone-600 hover:bg-stone-50 border border-stone-100 w-full sm:w-auto justify-between sm:justify-start">
                        <div class="flex items-center gap-2">
                            <i data-lucide="coffee" id="icon-food" class="w-4 h-4 text-stone-400 transition-colors duration-300"></i>
                            <span class="font-bold text-xs">Yummy Food?</span>
                        </div>
                        <div id="toggle-food-bg" class="w-10 h-6 rounded-full relative transition-colors duration-300 bg-stone-200">
                            <div id="toggle-food-dot" class="absolute top-1 w-4 h-4 rounded-full bg-white shadow-sm transition-all duration-300 translate-x-1"></div>
                        </div>
                    </button>
                </div>

                <!-- Hourly Cards Container -->
                <div id="timeline-container" class="space-y-4 pb-20">
                    <!-- JS Injected -->
                </div>
            </section>

        </main>
    </div>

    <!-- Intro / Warning Floating Toast -->
    <div id="intro-toast" class="fixed bottom-6 right-6 max-w-sm w-[calc(100%-3rem)] bg-white/95 backdrop-blur-xl p-5 rounded-2xl shadow-2xl shadow-stone-900/10 border border-stone-200 z-50 transform transition-all duration-500 hidden">
        <div class="flex items-start gap-4">
            <div class="p-2.5 bg-amber-50 text-amber-500 rounded-xl shrink-0">
                <i data-lucide="alert-triangle" class="w-5 h-5"></i>
            </div>
            <div>
                <h4 class="font-bold text-stone-800 mb-1">Important: Data Safety</h4>
                <p class="text-xs text-stone-500 leading-relaxed mb-3">
                    Your logs are saved in this browser's cache. 
                    <span class="font-bold text-amber-600">Clearing your browser history/cache will delete all your progress.</span>
                </p>
                <div class="flex gap-2">
                    <button id="btn-intro-gotit" class="text-xs font-bold text-stone-400 hover:text-stone-600 px-3 py-2 rounded-lg hover:bg-stone-50 transition-colors">Got it</button>
                    <button id="btn-intro-backup" class="text-xs font-bold text-sky-600 bg-sky-50 hover:bg-sky-100 px-3 py-2 rounded-lg transition-colors">Backup Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Management Modal -->
    <div id="modal-data" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/20 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <div class="bg-white/95 backdrop-blur-xl rounded-[2rem] p-8 w-full max-w-md shadow-2xl border border-white/50 transform scale-95 transition-transform duration-300">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-stone-800">Manage Data</h3>
                <button id="btn-close-data" class="p-2 hover:bg-stone-100 rounded-full text-stone-400 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div class="p-4 bg-sky-50 rounded-2xl border border-sky-100">
                    <h4 class="font-bold text-sky-700 mb-1 flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Export Backup
                    </h4>
                    <p class="text-xs text-sky-600/80 mb-3">Save all your logs to a JSON file.</p>
                    <button id="btn-export-all" class="w-full py-2.5 bg-sky-500 hover:bg-sky-600 text-white font-bold rounded-xl text-sm transition-colors shadow-sm shadow-sky-200">
                        Download All Data
                    </button>
                </div>
                <div class="p-4 bg-matcha-100/50 rounded-2xl border border-matcha-200">
                    <h4 class="font-bold text-matcha-600 mb-1 flex items-center gap-2">
                        <i data-lucide="upload" class="w-4 h-4"></i> Import Backup
                    </h4>
                    <p class="text-xs text-matcha-600/80 mb-3">Restore your data from a file.</p>
                    <input type="file" id="import-file" accept=".json" class="hidden" />
                    <button id="btn-import-trigger" class="w-full py-2.5 bg-white border border-matcha-300 text-matcha-600 hover:bg-matcha-50 font-bold rounded-xl text-sm transition-colors">
                        Select File to Restore
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- OJT Settings Modal -->
    <div id="modal-settings" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-stone-900/20 backdrop-blur-md opacity-0 transition-opacity duration-300">
        <div class="bg-white/95 backdrop-blur-xl rounded-[2rem] p-8 w-full max-w-md shadow-2xl border border-white/50 transform scale-95 transition-transform duration-300">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-stone-800">OJT Settings</h3>
                <button id="btn-close-settings" class="p-2 hover:bg-stone-100 rounded-full text-stone-400 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-stone-500 uppercase tracking-wider block mb-2">Start Date</label>
                    <input type="date" id="setting-start-date" class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-stone-700 outline-none focus:ring-2 focus:ring-matcha-400/50">
                </div>
                <div>
                    <label class="text-xs font-bold text-stone-500 uppercase tracking-wider block mb-2">Required Hours</label>
                    <input type="number" id="setting-total-hours" placeholder="e.g. 600" class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-stone-700 outline-none focus:ring-2 focus:ring-matcha-400/50">
                </div>
                <button id="btn-save-settings" class="w-full py-3 bg-matcha-500 hover:bg-matcha-600 text-white font-bold rounded-xl transition-colors shadow-lg shadow-matcha-200 mt-2">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS ---
            const HOURS = [
                "07:00 AM", "08:00 AM", "09:00 AM", "10:00 AM", "11:00 AM", 
                "12:00 PM", "01:00 PM", "02:00 PM", "03:00 PM", "04:00 PM", "05:00 PM"
            ];
            const MOODS = [
                { emoji: 'ðŸ˜Š', label: 'Happy', value: 'happy' },
                { emoji: 'ðŸ˜', label: 'Neutral', value: 'neutral' },
                { emoji: 'ðŸ˜«', label: 'Stressed', value: 'stressed' },
                { emoji: 'ðŸ˜´', label: 'Tired', value: 'tired' },
                { emoji: 'ðŸ”¥', label: 'On Fire', value: 'productive' }
            ];
            const moodColors = { 'happy': '#77B42B', 'neutral': '#a8a29e', 'stressed': '#F43F5E', 'tired': '#8B5CF6', 'productive': '#F59E0B' };
            const stressColors = { 1: '#77B42B', 2: '#a3e635', 3: '#facc15', 4: '#fb923c', 5: '#ef4444' };
            const WEATHER = [
                { icon: 'sun', label: 'Sunny', color: 'text-amber-400' },
                { icon: 'cloud', label: 'Cloudy', color: 'text-stone-400' },
                { icon: 'cloud-rain', label: 'Rainy', color: 'text-sky-400' },
                { icon: 'cloud-lightning', label: 'Stormy', color: 'text-violet-400' }
            ];

            // --- STATE ---
            let selectedDate = new Date();
            let currentMonth = new Date(); 
            let dailyLog = {};
            let userName = localStorage.getItem('ojt_pulse_username') || 'Student';
            let ojtSettings = JSON.parse(localStorage.getItem('ojt_pulse_settings')) || { startDate: '', totalHours: 600 };

            // --- DOM ELEMENTS ---
            const elApp = document.getElementById('app');
            const elLoading = document.getElementById('loading');
            const elTimeline = document.getElementById('timeline-container');
            const elUserDisplayName = document.getElementById('user-display-name');
            const elHeaderDate = document.getElementById('header-date');
            const elRoadmapTitle = document.getElementById('roadmap-title');
            const elScratchpad = document.getElementById('scratchpad');
            const elProgressPercent = document.getElementById('progress-percent');
            const elProgressHours = document.getElementById('progress-hours');
            const elProgressBar = document.getElementById('progress-bar');
            const elProgressDays = document.getElementById('progress-days');
            const elStatProductivity = document.getElementById('stat-productivity');
            const elStatTension = document.getElementById('stat-tension');
            const elTensionDots = document.getElementById('tension-dots');
            const elMoodPie = document.getElementById('mood-pie-chart');
            const elDatePicker = document.getElementById('date-picker-input');
            const elDateDisplay = document.getElementById('current-date-display');
            const elBigClock = document.getElementById('big-clock');
            const elCalMonthYear = document.getElementById('cal-month-year');
            const elMiniCalendar = document.getElementById('mini-calendar');

            // --- SAFE LISTENER HELPER ---
            const safeAddListener = (id, event, handler) => {
                const el = document.getElementById(id);
                if (el) el.addEventListener(event, handler);
            };

            // --- FUNCTIONS DEFINITIONS ---

            // Expose slider style update globally for inline usage
            window.updateSliderColor = (input) => {
                const val = input.value;
                const color = stressColors[val];
                input.style.setProperty('--thumb-color', color);
            };

            function formatDateKey(date) { return date.toISOString().split('T')[0]; }
            function formatDateDisplay(date) {
                const today = new Date();
                const todayStr = formatDateKey(today);
                const dateStr = formatDateKey(date);
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = formatDateKey(yesterday);

                if (dateStr === todayStr) return "Today";
                if (dateStr === yesterdayStr) return "Yesterday";
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }

            function changeDate(days) {
                selectedDate.setDate(selectedDate.getDate() + days);
                currentMonth = new Date(selectedDate);
                loadData();
            }

            function changeMonth(delta) {
                currentMonth.setMonth(currentMonth.getMonth() + delta);
                renderCalendar();
            }

            function renderCalendar() {
                if(!elCalMonthYear || !elMiniCalendar) return;
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                elCalMonthYear.innerText = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const todayStr = formatDateKey(new Date());
                const selectedStr = formatDateKey(selectedDate);

                elMiniCalendar.innerHTML = '';

                for (let i = 0; i < firstDay; i++) {
                    elMiniCalendar.innerHTML += `<div class="calendar-day empty"></div>`;
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const dateStr = formatDateKey(date);
                    let classes = 'calendar-day';
                    if (dateStr === todayStr) classes += ' today';
                    if (dateStr === selectedStr) classes += ' active';

                    const el = document.createElement('div');
                    el.className = classes;
                    el.innerText = day;
                    el.onclick = () => {
                        selectedDate = date;
                        loadData();
                    };
                    elMiniCalendar.appendChild(el);
                }
            }

            function updateProgress() {
                if(!elProgressPercent) return;
                const totalRequired = parseInt(ojtSettings.totalHours) || 600;
                let filledHoursCount = 0;
                for(let i=0; i<localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if(key.startsWith('ojt_pulse_')) {
                        try {
                            const dayData = JSON.parse(localStorage.getItem(key));
                            if(dayData.hours) {
                                Object.values(dayData.hours).forEach(h => {
                                    if(h.task && h.task.trim().length > 0) filledHoursCount++;
                                });
                            }
                        } catch(e) {}
                    }
                }

                const percent = Math.min(100, Math.round((filledHoursCount / totalRequired) * 100));
                elProgressPercent.innerText = `${percent}%`;
                elProgressHours.innerText = `${filledHoursCount} / ${totalRequired} hrs`;
                elProgressBar.style.width = `${percent}%`;

                if(ojtSettings.startDate) {
                    const start = new Date(ojtSettings.startDate);
                    const now = new Date();
                    const diffTime = now - start;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    elProgressDays.innerText = diffDays > 0 ? `Day ${diffDays} of Internship` : `Starts in ${Math.abs(diffDays)} days`;
                } else {
                    elProgressDays.innerText = `Set Start Date in Settings`;
                }
            }

            function loadData() {
                const keyDate = formatDateKey(selectedDate);
                const key = `ojt_pulse_${keyDate}`;
                
                if(elHeaderDate) elHeaderDate.innerText = formatDateDisplay(selectedDate);
                if(elDatePicker) elDatePicker.value = keyDate;
                
                const displayDate = formatDateDisplay(selectedDate);
                if(elRoadmapTitle) elRoadmapTitle.innerText = displayDate === "Today" ? "Today's Roadmap" : `Roadmap for ${displayDate}`;

                const stored = localStorage.getItem(key);
                if (stored) {
                    dailyLog = JSON.parse(stored);
                } else {
                    dailyLog = {
                        date: keyDate,
                        deliciousFood: false,
                        hours: HOURS.reduce((acc, h) => ({ ...acc, [h]: { task: '', stress: 1, mood: 'neutral', weather: 'Sunny' } }), {})
                    };
                }
                
                renderCalendar();
                renderUI();
                updateProgress();
                showApp();
            }

            function saveData() {
                const keyDate = formatDateKey(selectedDate);
                const key = `ojt_pulse_${keyDate}`;
                localStorage.setItem(key, JSON.stringify(dailyLog));
                renderUI(); // Re-render for analytics
                updateProgress();
            }

            function showApp() {
                elLoading.classList.add('opacity-0');
                setTimeout(() => {
                    elLoading.classList.add('hidden');
                    elApp.classList.remove('opacity-0');
                }, 300);
            }

            // Expose updateHour globally for inline HTML events
            window.updateHour = (hour, field, value) => {
                if (!dailyLog.hours) return;
                if (field === 'stress') value = parseInt(value);
                dailyLog.hours[hour] = { ...dailyLog.hours[hour], [field]: value };
                saveData();
            };

            function toggleFood() {
                dailyLog.deliciousFood = !dailyLog.deliciousFood;
                saveData();
            }

            function renderUI() {
                renderFoodButton();
                renderTimeline();
                renderAnalytics();
                lucide.createIcons(); 
            }

            function renderFoodButton() {
                const btn = document.getElementById('btn-food');
                const bg = document.getElementById('toggle-food-bg');
                const dot = document.getElementById('toggle-food-dot');
                const icon = document.getElementById('icon-food');
                if(!btn) return;

                const isActive = dailyLog.deliciousFood;

                if (isActive) {
                    btn.className = 'flex items-center gap-3 pl-4 pr-1.5 py-1.5 rounded-[1.2rem] transition-all duration-300 shadow-sm bg-matcha-500 text-white shadow-matcha-200/50 hover:bg-matcha-600 border border-matcha-500 w-full sm:w-auto justify-between sm:justify-start';
                    bg.classList.remove('bg-stone-200');
                    bg.classList.add('bg-white/20');
                    dot.classList.remove('translate-x-1');
                    dot.classList.add('translate-x-5'); 
                    icon.classList.remove('text-stone-400');
                    icon.classList.add('text-white');
                } else {
                    btn.className = 'flex items-center gap-3 pl-4 pr-1.5 py-1.5 rounded-[1.2rem] transition-all duration-300 shadow-sm bg-white text-stone-600 hover:bg-stone-50 border border-stone-100 w-full sm:w-auto justify-between sm:justify-start';
                    bg.classList.add('bg-stone-200');
                    bg.classList.remove('bg-white/20');
                    dot.classList.add('translate-x-1');
                    dot.classList.remove('translate-x-5');
                    icon.classList.add('text-stone-400');
                    icon.classList.remove('text-white');
                }
            }

            function renderTimeline() {
                if(!elTimeline) return;
                const activeId = document.activeElement ? document.activeElement.id : null;
                let cursorLoc = null;
                if(activeId && document.activeElement.tagName === 'INPUT') {
                    cursorLoc = document.activeElement.selectionStart;
                }

                const examples = [
                    "Drafting the project documentation",
                    "Debugging the API connection issue",
                    "Daily team stand-up meeting",
                    "Learning React hooks and context",
                    "Refactoring the legacy codebase",
                    "Code review for the payment module",
                    "Coffee break & quick stretch â˜•",
                    "Updating the Kanban task board",
                    "Reading up on Tailwind CSS best practices",
                    "Responding to client emails",
                    "Planning the next sprint cycle"
                ];

                elTimeline.innerHTML = HOURS.map((hour, index) => {
                    const data = dailyLog.hours?.[hour] || {};
                    const isActive = data.task && data.task.length > 0;
                    
                    const weatherHtml = WEATHER.map(w => {
                        const isSelected = data.weather === w.label;
                        const classes = isSelected 
                            ? `bg-white shadow-sm ${w.color}` 
                            : 'text-stone-300 hover:text-stone-400';
                        return `
                            <button onclick="updateHour('${hour}', 'weather', '${w.label}')" 
                                class="p-1.5 rounded-lg transition-all ${classes}" title="${w.label}">
                                <i data-lucide="${w.icon}" class="w-3.5 h-3.5"></i>
                            </button>
                        `;
                    }).join('');

                    const moodHtml = MOODS.map(m => {
                        const isSelected = data.mood === m.value;
                        const classes = isSelected 
                            ? 'bg-white shadow-md scale-110 -translate-y-1' 
                            : 'bg-stone-50 text-stone-300 hover:bg-stone-100 hover:text-stone-500';
                        return `
                            <button onclick="updateHour('${hour}', 'mood', '${m.value}')" 
                                class="w-9 h-9 rounded-xl flex items-center justify-center text-base transition-all duration-200 ${classes}" 
                                title="${m.label}">
                                ${m.emoji}
                            </button>
                        `;
                    }).join('');

                    const stressVal = data.stress || 1;
                    const currentStressColor = stressColors[stressVal];
                    const placeholder = `e.g. ${examples[index % examples.length]}`;

                    return `
                    <div class="group relative">
                        <div class="w-full bg-white/70 backdrop-blur-md p-5 rounded-[1.8rem] shadow-sm border border-white/60 transition-all duration-300 hover:bg-white/90 hover:shadow-lg hover:shadow-matcha-200/10 ${isActive ? 'ring-1 ring-matcha-200' : ''}">
                            <div class="flex flex-col gap-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-2xl font-black text-stone-700 tracking-tight">${hour}</span>
                                    <div class="flex gap-1 p-1 bg-stone-100/50 rounded-lg">
                                        ${weatherHtml}
                                    </div>
                                </div>

                                <div class="space-y-1.5">
                                    <label for="input-${hour}" class="text-[9px] font-bold text-stone-400 uppercase tracking-widest ml-1">Activity</label>
                                    <div class="relative group/input">
                                        <input 
                                            id="input-${hour}"
                                            type="text"
                                            placeholder="${placeholder}"
                                            value="${data.task || ''}"
                                            onchange="updateHour('${hour}', 'task', this.value)"
                                            class="w-full bg-stone-50/50 hover:bg-white border border-stone-200/50 rounded-2xl px-4 py-3 text-sm text-stone-700 placeholder:text-stone-400 focus:ring-2 focus:ring-matcha-400/30 focus:bg-white focus:border-matcha-200 transition-all outline-none font-medium"
                                        />
                                        <div class="absolute right-4 top-3.5 transition-all duration-300 ${isActive ? 'opacity-100 scale-100' : 'opacity-0 scale-50'}">
                                            <i data-lucide="check-circle-2" class="w-5 h-5 text-matcha-500 fill-matcha-100"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex flex-col lg:flex-row gap-4 pt-1">
                                    <div class="flex-1 space-y-2">
                                        <div class="flex justify-between items-center px-1">
                                            <span class="text-[9px] font-bold text-stone-400 uppercase tracking-widest">Stress</span>
                                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-md" style="background-color: ${currentStressColor}20; color: ${currentStressColor};">${stressVal} / 5</span>
                                        </div>
                                        <input 
                                            type="range" min="1" max="5" step="1"
                                            value="${stressVal}"
                                            style="--thumb-color: ${currentStressColor}"
                                            onchange="updateHour('${hour}', 'stress', this.value)"
                                            oninput="updateSliderColor(this)"
                                            class="w-full h-1.5 bg-stone-100 rounded-lg"
                                        />
                                    </div>
                                    <div class="space-y-2">
                                        <p class="text-[9px] font-bold text-stone-400 uppercase tracking-widest px-1">Vibe</p>
                                        <div class="flex gap-1.5">
                                            ${moodHtml}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

                if(activeId) {
                    const el = document.getElementById(activeId);
                    if(el) {
                        el.focus();
                        if(cursorLoc !== null) el.setSelectionRange(cursorLoc, cursorLoc);
                    }
                }
            }

            function renderAnalytics() {
                if (!dailyLog.hours) return;
                const logs = Object.values(dailyLog.hours);
                const filledTasks = logs.filter(l => l.task && l.task.trim().length > 0).length;
                const productivity = Math.round((filledTasks / HOURS.length) * 100);
                const totalStress = logs.reduce((acc, l) => acc + (l.stress || 1), 0);
                const avgStress = (totalStress / logs.length).toFixed(1);
                const moodCounts = logs.reduce((acc, l) => {
                    const m = l.mood || 'neutral';
                    acc[m] = (acc[m] || 0) + 1;
                    return acc;
                }, {});

                if(elStatProductivity) elStatProductivity.innerText = `${productivity}%`;
                if(elStatTension) elStatTension.innerText = avgStress;

                if(elTensionDots) {
                    elTensionDots.innerHTML = [1,2,3,4,5].map(i => {
                        const isActive = i <= Math.round(avgStress);
                        const colorClass = isActive ? 'bg-rose-400' : 'bg-rose-100';
                        return `<div class="w-1.5 h-1.5 rounded-full ${colorClass}"></div>`;
                    }).join('');
                }

                renderPieChart(moodCounts, logs.length);
            }

            function renderPieChart(moodCounts, total) {
                if(!elMoodPie) return;
                if (total === 0) {
                    elMoodPie.style.background = '#e7e5e4'; 
                    return;
                }
                let currentPercent = 0;
                const segments = [];
                Object.keys(moodCounts).forEach(mood => {
                    const count = moodCounts[mood];
                    const percent = (count / total) * 100;
                    const color = moodColors[mood] || '#e7e5e4';
                    segments.push(`${color} ${currentPercent}% ${currentPercent + percent}%`);
                    currentPercent += percent;
                });
                elMoodPie.style.background = `conic-gradient(${segments.join(', ')})`;
            }

            // --- DATA MANAGEMENT ---
            const modalData = document.getElementById('modal-data');
            const modalSettings = document.getElementById('modal-settings');
            const introToast = document.getElementById('intro-toast');

            function toggleDataModal(show) {
                const inner = modalData.querySelector('div');
                if (show) {
                    modalData.classList.remove('hidden');
                    setTimeout(() => { modalData.classList.remove('opacity-0'); inner.classList.remove('scale-95'); }, 10);
                } else {
                    modalData.classList.add('opacity-0'); inner.classList.add('scale-95');
                    setTimeout(() => { modalData.classList.add('hidden'); }, 300);
                }
            };
            window.openDataModal = () => toggleDataModal(true);

            function toggleSettingsModal(show) {
                const inner = modalSettings.querySelector('div');
                if(show) {
                    document.getElementById('setting-start-date').value = ojtSettings.startDate;
                    document.getElementById('setting-total-hours').value = ojtSettings.totalHours;
                    modalSettings.classList.remove('hidden');
                    setTimeout(() => { modalSettings.classList.remove('opacity-0'); inner.classList.remove('scale-95'); }, 10);
                } else {
                    modalSettings.classList.add('opacity-0'); inner.classList.add('scale-95');
                    setTimeout(() => { modalSettings.classList.add('hidden'); }, 300);
                }
            }
            
            function saveSettings() {
                ojtSettings.startDate = document.getElementById('setting-start-date').value;
                ojtSettings.totalHours = document.getElementById('setting-total-hours').value;
                localStorage.setItem('ojt_pulse_settings', JSON.stringify(ojtSettings));
                updateProgress();
                toggleSettingsModal(false);
            }

            function dismissIntro() {
                introToast.style.opacity = '0';
                introToast.style.transform = 'translateY(20px)';
                setTimeout(() => introToast.classList.add('hidden'), 500);
                localStorage.setItem('ojt_pulse_seen_intro', 'true');
            };
            setTimeout(() => { if (!localStorage.getItem('ojt_pulse_seen_intro')) introToast.classList.remove('hidden'); }, 1500);

            function exportData() {
                const allData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('ojt_pulse_')) {
                        allData[key] = JSON.parse(localStorage.getItem(key));
                    }
                }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
                const a = document.createElement('a');
                a.href = dataStr;
                a.download = `OJT_Backup_${formatDateKey(new Date())}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            }

            function importData(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        Object.keys(data).forEach(k => { if(k.startsWith('ojt_pulse_')) localStorage.setItem(k, JSON.stringify(data[k])); });
                        alert('Restored!'); location.reload();
                    } catch (err) { console.error(err); alert('Error reading file.'); }
                };
                reader.readAsText(file);
            }

            function updateClock() {
                const now = new Date();
                let hours = now.getHours();
                const minutes = now.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; 
                const strTime = hours + ':' + (minutes < 10 ? '0' + minutes : minutes);
                if (elBigClock) {
                    elBigClock.innerHTML = `<span>${strTime}</span><span class="text-xs text-stone-400 font-medium">${ampm}</span>`;
                }
            }
            setInterval(updateClock, 1000);
            updateClock(); 

            // --- INITIALIZATION (LISTENERS AT THE END) ---
            if(elUserDisplayName) elUserDisplayName.value = userName;
            safeAddListener('user-display-name', 'input', (e) => {
                userName = e.target.value;
                localStorage.setItem('ojt_pulse_username', userName);
            });

            // Scratchpad Logic
            if(elScratchpad) {
                elScratchpad.value = localStorage.getItem('ojt_pulse_scratchpad') || '';
                elScratchpad.addEventListener('input', (e) => {
                    localStorage.setItem('ojt_pulse_scratchpad', e.target.value);
                });
            }

            // Date Controls
            safeAddListener('btn-prev-day', 'click', () => changeDate(-1));
            safeAddListener('btn-next-day', 'click', () => changeDate(1));
            if(elDatePicker) {
                elDatePicker.addEventListener('change', (e) => {
                    if(e.target.value) {
                        selectedDate = new Date(e.target.value);
                        currentMonth = new Date(selectedDate);
                        loadData();
                    }
                });
            }

            // Calendar Nav
            safeAddListener('btn-cal-prev', 'click', () => changeMonth(-1));
            safeAddListener('btn-cal-next', 'click', () => changeMonth(1));

            // Settings Button
            safeAddListener('btn-settings', 'click', () => toggleSettingsModal(true));
            safeAddListener('btn-close-settings', 'click', () => toggleSettingsModal(false));
            safeAddListener('btn-save-settings', 'click', saveSettings);

            // Data Modal Buttons
            safeAddListener('btn-data-modal', 'click', () => toggleDataModal(true));
            safeAddListener('btn-close-data', 'click', () => toggleDataModal(false));
            safeAddListener('btn-export-all', 'click', exportData);
            safeAddListener('btn-import-trigger', 'click', () => document.getElementById('import-file').click());
            safeAddListener('import-file', 'change', importData);

            // Food Button
            safeAddListener('btn-food', 'click', toggleFood);

            // Intro Toast
            safeAddListener('btn-intro-gotit', 'click', dismissIntro);
            safeAddListener('btn-intro-backup', 'click', () => { openDataModal(); dismissIntro(); });

            // Initialize Data
            loadData();
        });
    </script>
</body>
</html>
